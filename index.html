<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game dos Correia - Host Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #1a1a2e; color: #fff; margin: 0; padding: 10px; display: flex; justify-content: center; }
        .hidden { display: none !important; }
        #login-screen { text-align: center; margin-top: 10vh; padding: 30px; background: #16213e; border-radius: 15px; width: 320px; border: 1px solid #e94560; }
        input { padding: 12px; border-radius: 5px; border: none; width: 90%; margin-bottom: 15px; font-size: 16px; color: #000; }
        button { padding: 10px 15px; background-color: #e94560; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #dashboard { width: 100%; max-width: 1100px; }
        header { display: flex; justify-content: space-between; align-items: center; background: #16213e; padding: 20px; border-radius: 15px; margin-bottom: 20px; border-bottom: 4px solid #e94560; }
        .container { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
        @media (max-width: 800px) { .container { grid-template-columns: 1fr; } }
        .card { background: #0f3460; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .rank-item { padding: 10px; margin-bottom: 8px; background: #16213e; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #1f2d52; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .online-dot { background-color: #4ecca3; box-shadow: 0 0 8px #4ecca3; }
        .offline-dot { background-color: #555; }
        #video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; background: #000; padding: 12px; border-radius: 12px; }
        .video-box { position: relative; background: #222; border-radius: 8px; overflow: hidden; aspect-ratio: 4/3; }
        video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>üé≤ Game dos Correia</h1>
        <input type="text" id="username" placeholder="Seu Nome">
        <button onclick="login()">ENTRAR</button>
    </div>

    <div id="dashboard" class="hidden">
        <header>
            <h2 id="user-display">---</h2>
            <div>üèÜ <span id="my-score">0</span> | üí∞ <span id="my-coins">0</span></div>
            <button onclick="logout()" style="background:#333">Sair</button>
        </header>

        <div class="container">
            <div class="column">
                <section class="card">
                    <h3>üü¢ Online</h3>
                    <div id="online-list"></div>
                    <hr style="border:0; border-top:1px solid #16213e; margin:10px 0;">
                    <h3>‚ö™ Offline</h3>
                    <div id="offline-list"></div>
                </section>

                <section id="host-panel" class="card hidden" style="border: 2px solid #ff4d6d;">
                    <h3 style="color:#ff4d6d">‚öôÔ∏è Painel do Host</h3>
                    <button onclick="resetarTudo()" style="width:100%; background:#ff4d6d">üîÑ ZERAR RANKING GERAL</button>
                </section>
                
                <section class="card">
                    <h3>üìπ V√≠deo</h3>
                    <button onclick="initCamera()" style="width:100%; background:#4a90e2; margin-bottom:10px;">üé• Ligar C√¢mera</button>
                    <div id="video-grid" class="hidden">
                        <div class="video-box">
                            <video id="localVideo" autoplay muted playsinline style="transform: scaleX(-1);"></video>
                        </div>
                    </div>
                </section>
            </div>

            <div class="column">
                <section class="card">
                    <h3>üéÆ Jogo</h3>
                    <button style="width:100%; height:50px; background:#4ecca3; color:#000;" onclick="ganheiRodada()">‚≠ê GANHEI RODADA</button>
                </section>
                <section class="card">
                    <h3>üí¨ Chat</h3>
                    <div id="chat-box" style="height:150px; overflow-y:auto; font-size:0.9em; margin-bottom:10px; background: #16213e; padding: 5px; border-radius: 5px;"></div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="chat-input" placeholder="Mensagem..." style="flex:1;">
                        <button onclick="enviarMsg()">Enviar</button>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        const BIN_ID = '695dbb1a43b1c97be91e392b'; 
        const API_KEY = '$2a$10$TFRelzQbssgoIdAi7ynyTeMqqatmKYCyEtwHBiIhqvK2Vn0A3OvNS';
        const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        let users = [], currentUser = null, chatGlobal = [];

        async function login() {
            let name = document.getElementById('username').value.trim();
            if (!name) return;
            
            // L√≥gica de Host (Samuel Correia) ou Jogador
            if (name !== "Samuel Correia") name = name.toUpperCase();
            
            sessionStorage.setItem('loggedUser', name);
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('user-display').innerText = name;

            if (name === "Samuel Correia") {
                document.getElementById('host-panel').classList.remove('hidden');
            }

            // Cria usu√°rio local para aparecer na lista na hora
            currentUser = { username: name, score: 0, coins: 50, online: true };
            users = [currentUser]; 
            updateUI();

            // Busca dados do servidor e sincroniza
            await syncData();
            
            let userExists = users.find(u => u.username === name);
            if (!userExists) {
                users.push(currentUser);
            } else {
                userExists.online = true;
                currentUser = userExists;
            }
            await save();
        }

        async function save() {
            try {
                await fetch(URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify({ users, chat: chatGlobal })
                });
            } catch (e) { console.error("Erro ao salvar"); }
        }

        async function syncData() {
            try {
                const res = await fetch(URL, { headers: { 'X-Master-Key': API_KEY } });
                const data = await res.json();
                if (data.record) {
                    users = data.record.users || [];
                    chatGlobal = data.record.chat || [];
                    updateUI();
                }
            } catch (e) { }
        }

        function updateUI() {
            const name = sessionStorage.getItem('loggedUser');
            if (!name) return;

            const me = users.find(u => u.username === name) || currentUser;
            document.getElementById('my-score').innerText = me.score;
            document.getElementById('my-coins').innerText = me.coins;

            document.getElementById('online-list').innerHTML = users.filter(u => u.online).map(u => `
                <div class="rank-item">
                    <span><span class="status-dot online-dot"></span>${u.username}</span>
                    <b>${u.score} pts</b>
                </div>`).join('');
            
            document.getElementById('offline-list').innerHTML = users.filter(u => !u.online).map(u => `
                <div class="rank-item">
                    <span><span class="status-dot offline-dot"></span>${u.username}</span>
                    <b>${u.score} pts</b>
                </div>`).join('');

            document.getElementById('chat-box').innerHTML = chatGlobal.map(m => `<div><b>${m.id}:</b> ${m.msg}</div>`).join('');
        }

        function ganheiRodada() {
            const name = sessionStorage.getItem('loggedUser');
            let me = users.find(u => u.username === name);
            if(me) { me.score += 10; me.coins += 5; save(); updateUI(); }
        }

        function enviarMsg() {
            const name = sessionStorage.getItem('loggedUser');
            const i = document.getElementById('chat-input');
            if(!i.value.trim()) return;
            chatGlobal.push({id: name, msg: i.value});
            if(chatGlobal.length > 15) chatGlobal.shift();
            i.value = ""; save(); updateUI();
        }

        function resetarTudo() {
            if(confirm("Zerar todos os pontos?")) {
                users.forEach(u => u.score = 0);
                save(); updateUI();
            }
        }

        async function logout() {
            const name = sessionStorage.getItem('loggedUser');
            let me = users.find(u => u.username === name);
            if(me) me.online = false;
            await save();
            sessionStorage.clear();
            location.reload();
        }

        async function initCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('localVideo').srcObject = stream;
            document.getElementById('video-grid').classList.remove('hidden');
        }

        setInterval(syncData, 4000);
    </script>
</body>
</html>
