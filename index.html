<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Jogos - 100 Emojis v43 Global</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #1a1a2e; color: #fff; margin: 0; display: flex; justify-content: center; padding: 10px; }
        .hidden { display: none !important; }
        #login-screen { text-align: center; margin-top: 10vh; padding: 30px; background: #16213e; border-radius: 15px; width: 320px; border: 1px solid #e94560; }
        input { padding: 12px; border-radius: 5px; border: none; width: 90%; margin-bottom: 15px; font-size: 16px; background: #fff; color: #000; }
        button { padding: 10px 15px; background-color: #e94560; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; }
        #dashboard { width: 100%; max-width: 1100px; }
        header { display: flex; justify-content: space-between; align-items: center; background: #16213e; padding: 20px; border-radius: 15px; margin-bottom: 20px; border-bottom: 4px solid #e94560; }
        .container { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
        @media (max-width: 800px) { .container { grid-template-columns: 1fr; } }
        .card { background: #0f3460; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        h3 { margin: 0 0 10px 0; color: #e94560; text-transform: uppercase; font-size: 0.85em; border-bottom: 1px solid #1a1a2e; padding-bottom: 5px; }
        .rank-item { padding: 10px; margin-bottom: 8px; background: #16213e; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; border: 1px solid #1f2d52; }
        
        #video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; background: #000; padding: 12px; border-radius: 12px; margin-top: 10px; }
        .video-box { position: relative; background: #222; border-radius: 8px; overflow: hidden; aspect-ratio: 4/3; border: 2px solid #333; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { transform: scaleX(-1); }
        .video-label { position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); padding: 2px 8px; font-size: 10px; border-radius: 4px; }
        .video-controls { position: absolute; top: 5px; right: 5px; display: flex; gap: 4px; z-index: 10; }
        .control-btn { background: rgba(0,0,0,0.6); border: none; color: white; padding: 4px; border-radius: 50%; cursor: pointer; width: 26px; height: 26px; font-size: 12px; }

        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .online-dot { background-color: #4ecca3; box-shadow: 0 0 8px #4ecca3; }
        .offline-dot { background-color: #555; }
        
        .chat-box { height: 150px; overflow-y: auto; background: #16213e; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8em; }
        .chat-input-area { display: flex; gap: 5px; position: relative; }
    </style>
</head>
<body>
    <div id="login-screen">
        <h1>ğŸ² Game dos Correia</h1>
        <input type="text" id="username" placeholder="SEU NOME">
        <button onclick="login()">ENTRAR</button>
    </div>

    <div id="dashboard" class="hidden">
        <div id="spy-indicator" class="spy-alert hidden">MODO ESPIÃƒO ATIVO</div>
        <header>
            <div>
                <h2 id="user-display">---</h2>
                <div id="shield-status" style="color: #4ecca3; font-size: 0.8em; font-weight: bold;"></div>
            </div>
            <div style="text-align: right">
                <div>ğŸ† <span id="my-score">0</span> pts</div>
                <div style="color: #ffd700;">ğŸ’° <span id="my-coins">0</span></div>
            </div>
            <button onclick="logout()" style="background:#333">Sair</button>
        </header>

        <div class="container">
            <div class="column">
                <section class="card">
                    <h3>ğŸŸ¢ Online Agora</h3>
                    <div id="online-list"></div>
                    <hr style="border: 0; border-top: 1px solid #16213e; margin: 15px 0;">
                    <h3>âšª Offline</h3>
                    <div id="offline-list"></div>
                </section>
                
                <section class="card">
                    <h3>ğŸ“¹ VÃ­deo Chamada</h3>
                    <button onclick="initCamera()" style="width:100%; background:#4a90e2">ğŸ¥ ATIVAR MINHA CÃ‚MERA</button>
                    <div id="video-grid" class="hidden">
                        <div class="video-box" id="local-video-box">
                            <div class="video-controls">
                                <button class="control-btn" onclick="toggleMic()">ğŸ¤</button>
                                <button class="control-btn" onclick="toggleCam()">ğŸ“·</button>
                            </div>
                            <span class="video-label">VocÃª</span>
                            <video id="localVideo" autoplay muted playsinline></video>
                        </div>
                    </div>
                </section>

                <section id="host-panel" class="card hidden" style="border: 2px solid #ff4d6d;">
                    <h3>âš™ï¸ Host: AÃ§Ãµes Globais</h3>
                    <button onclick="resetarPontosGeral()" style="width:100%; background: #ff4d6d;">ğŸ”„ ZERAR TUDO</button>
                </section>
            </div>

            <div class="column">
                <section class="card">
                    <h3>ğŸ›’ Loja de Itens</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                        <button onclick="buy(100, 'Escudo')">ğŸ›¡ï¸ Escudo (100ğŸ’°)</button>
                        <button onclick="buy(500, 'Roubo')">ğŸ’¸ Roubo (500ğŸ’°)</button>
                        <button onclick="buy(800, 'InvasÃ£o')" style="background:#6a0572">ğŸ•µï¸ InvasÃ£o (800ğŸ’°)</button>
                        <button onclick="buy(1000, 'Redemoinho')" style="background:#2d4059">ğŸŒªï¸ Redemoinho (1000ğŸ’°)</button>
                        <button onclick="buy(600, 'Bomba')" style="background:#bf0603">ğŸ’£ Bomba (600ğŸ’°)</button>
                    </div>
                </section>
                <section class="card">
                    <h3>ğŸ’ Meu InventÃ¡rio</h3>
                    <div id="inventory-list" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
                </section>
                <section class="card">
                    <h3>ğŸ® Jogo</h3>
                    <button style="width:100%; height: 40px; background:#4ecca3; color:#000" onclick="ganheiRodada()">â­ GANHEI RODADA</button>
                </section>
                <section class="card">
                    <h3>ğŸ’¬ Chat</h3>
                    <div id="chat-box" class="chat-box"></div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-input" placeholder="Mensagem..." onkeypress="if(event.key==='Enter') enviarMsg()" style="flex:1;">
                        <button onclick="enviarMsg()">Enviar</button>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        const BIN_ID = '695dbb1a43b1c97be91e392b'; 
        const API_KEY = '$2a$10$TFRelzQbssgoIdAi7ynyTeMqqatmKYCyEtwHBiIhqvK2Vn0A3OvNS';
        const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        let users = [], currentUser = null, spyTarget = null;
        let peer = null, localStream = null, chatGlobal = [];

        async function save() { 
            try {
                await fetch(URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify({ users, bannedUsers: [], chat: chatGlobal })
                });
            } catch (e) { console.error("Erro ao salvar"); }
        }

        async function syncData() {
            try {
                const response = await fetch(URL, { headers: { 'X-Master-Key': API_KEY } });
                const remote = await response.json();
                const data = remote.record;
                if (data && data.users) {
                    users = data.users;
                    chatGlobal = data.chat || [];
                    const loggedName = sessionStorage.getItem('loggedUser');
                    const updatedMe = users.find(u => u.username === loggedName);
                    if (updatedMe) currentUser = updatedMe;
                    updateUI(chatGlobal);
                }
            } catch (e) { console.error("Erro sincronia"); }
        }

        async function login() {
            let name = document.getElementById('username').value.trim();
            if (!name) return;
            if (name !== "Samuel Correia") name = name.toUpperCase();
            sessionStorage.setItem('loggedUser', name);
            
            // Busca dados antes de entrar para ver quem jÃ¡ estÃ¡ lÃ¡
            const response = await fetch(URL, { headers: { 'X-Master-Key': API_KEY } });
            const remote = await response.json();
            users = remote.record.users || [];

            let userExists = users.find(u => u.username === name);
            if (!userExists) {
                currentUser = { username: name, score: 0, coins: 50, inventory: [], shieldCharges: 0, online: true };
                users.push(currentUser);
            } else {
                userExists.online = true;
                currentUser = userExists;
            }

            await save(); // Salva que estou online
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            if (name === "Samuel Correia") document.getElementById('host-panel').classList.remove('hidden');
            
            initPeer(name);
            syncData(); // Atualiza a lista para ver os outros
        }

        function initPeer(n) { 
            const pId = n.replace(/\s+/g, '-') + "-Peer";
            peer = new Peer(pId); 
            peer.on('call', (c) => { 
                navigator.mediaDevices.getUserMedia({video:true, audio:true}).then((s) => { 
                    c.answer(s); 
                    addRemoteStream(c.peer.replace('-Peer',''), s); 
                }); 
            }); 
        }

        async function initCamera() { 
            localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true}); 
            document.getElementById('localVideo').srcObject = localStream; 
            document.getElementById('video-grid').classList.remove('hidden'); 
        }

        function toggleMic() { if(localStream) localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled; }
        function toggleCam() { if(localStream) localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled; }

        function ligarPara(id) { 
            if(!localStream) return alert("Ative sua cÃ¢mera!"); 
            const c = peer.call(id, localStream); 
            c.on('stream', (s) => addRemoteStream(id.replace('-Peer',''), s)); 
        }

        function addRemoteStream(n, s) { 
            if(document.getElementById("video-"+n)) return; 
            const b = document.createElement('div'); 
            b.className = "video-box"; b.id = "video-"+n; 
            b.innerHTML = `<span class="video-label">${n}</span><video id="vid-el-${n}" autoplay playsinline></video>`; 
            document.getElementById('video-grid').appendChild(b); 
            document.getElementById(`vid-el-${n}`).srcObject = s;
        }

        function updateUI(chat) {
            const displayData = currentUser;
            if (!displayData) return;
            document.getElementById('user-display').innerText = displayData.username;
            document.getElementById('my-score').innerText = displayData.score;
            document.getElementById('my-coins').innerText = displayData.coins;
            
            const sorted = [...users].sort((a,b) => b.score - a.score);
            const render = (u) => {
                const pId = u.username.replace(/\s+/g, '-') + "-Peer";
                return `<div class="rank-item">
                    <span><span class="status-dot ${u.online?'online-dot':'offline-dot'}"></span>${u.username}</span>
                    <div>
                        ${(u.online && u.username !== currentUser.username) ? `<button onclick="ligarPara('${pId}')" style="font-size:9px; background:#4ecca3; color:#000">ğŸ“</button>` : ''}
                        <span>${u.score} pts</span>
                    </div>
                </div>`;
            };
            
            document.getElementById('online-list').innerHTML = sorted.filter(u=>u.online).map(render).join('');
            document.getElementById('offline-list').innerHTML = sorted.filter(u=>!u.online).map(render).join('');
            document.getElementById('chat-box').innerHTML = chat.map(m => `<div><b>${m.id}:</b> ${m.msg}</div>`).join('');
            document.getElementById('inventory-list').innerHTML = displayData.inventory.map((item, i) => `<div class="item-card"><b>${item}</b></div>`).join('') || "Vazio";
        }

        function buy(p, t) { if(currentUser.coins >= p) { currentUser.coins -= p; currentUser.inventory.push(t); save(); } }
        function ganheiRodada() { currentUser.score += 10; currentUser.coins += 5; save(); }
        function enviarMsg() {
            const i = document.getElementById('chat-input'); if(!i.value.trim()) return;
            chatGlobal.push({id:currentUser.username, msg:i.value}); if(chatGlobal.length>15) chatGlobal.shift();
            i.value = ""; save();
        }
        function logout() { if(currentUser) currentUser.online = false; save().then(() => { sessionStorage.removeItem('loggedUser'); location.reload(); }); }
        
        setInterval(syncData, 3000);
    </script>
</body>
</html>
